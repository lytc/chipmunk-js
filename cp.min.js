/*
 * Copyright (c) 2007-2013 Scott Lembcke and Howling Moon Software
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 * 
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 * 
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

/*
 * Chipmunk JS 6.2.0 - Port of Chipmunk Physics
 * @author lytc
 */
!function(a,b){b.cp=a;var c=6,d=2,e=0,f=a,g=function(){},h=function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},i=function(a,b,c){var d=function(){this.constructor=b};return d.prototype=a.prototype,b.prototype=new d,c&&h(b.prototype,c),b.__super__=a.prototype,b},j=function(a,b){if(!a)throw console.trace(),new Error(b)},k=function(a,b){if(!a)throw console.trace(),new Error(b)},l=f.CP_HASH_PAIR=function(a,b){return b>a?a+" "+b:b+" "+a};f.versionString=c+"."+d+"."+e,f.momentForCircle=function(a,b,c,d){return a*(.5*(b*b+c*c)+_(d))},f.areaForCircle=function(a,b){return D*H(a*a-b*b)};var m=f.momentForSegment=function(a,b,c){var d=U(R(b,c),.5);return a*(fb(c,b)/12+_(d))};f.areaForSegment=function(a,b,c){return c*(D*c+2*eb(a,b))},f.momentForPoly=function(a,b,c){var d=b.length;if(2==d)return m(a,b[0],b[1]);for(var e=0,f=0,g=0;d>g;g++){var h=R(b[g],c),i=R(b[(g+1)%d],c),j=W(i,h),k=V(h,h)+V(h,i)+V(i,i);e+=j*k,f+=j}return a*e/(6*f)},f.areaForPoly=function(a){for(var b=0,c=a.length,d=0;c>d;d++)b+=W(a[d],a[(d+1)%c]);return-b/2};var n=f.centroidForPoly=function(a){for(var b=0,c=P,d=a.length,e=0;d>e;e++){var f=a[e],g=a[(e+1)%d],h=W(f,g);b+=h,c=R(c,U(R(f,g),h))}return U(c,1/(3*b))};f.recenterPoly=function(a){for(var b=n(a),c=a.length,d=0;c>d;d++)a[d]=S(a[d],b)};var o=f.momentForBox=function(a,b,c){return a*(b*b+c*c)/12};f.momentForBox2=function(a,b){var c=b.r-b.l,d=b.t-b.b,e=U(O(b.l+b.r,b.b+b.t),.5);return o(a,c,d)+a*_(e)};var p=f.loopIndexes=function(a,b){for(var c=0,d=0,e=a[0],f=e,g=1;b>g;g++){var h=a[g];h.x<e.x||h.x==e.x&&h.y<e.y?(e=h,c=g):(h.x>f.x||h.x==f.x&&h.y>f.y)&&(f=h,d=g)}return[c,d]},q=function(a,b,c){var d=a[c];a[c]=a[b],a[b]=d},r=function(a,b,c,d,e,f){if(0==c)return 0;for(var g=0,h=b,i=S(e,d),j=f*ab(i),k=b,l=b+c-1;l>=k;){var m=W(i,S(a[k],d));m>j?(m>g&&(g=m,h=k),k++):(q(a,k,l),l--)}return h!=b&&q(a,b,h),k-b},s=function(a,b,c,d,e,f,g,h){if(0>d)return 0;if(0==d)return b[h]=f,1;var i=r(b,c,d,e,f,a),j=s(a,b,c+1,i-1,e,b[c],f,h);b[h+j++]=f;var k=r(b,c+i,d-i,f,g,a);return j+s(a,b,c+i+1,k-1,f,b[c+i],g,h+j)};f.convexHull=function(a,b,c,d,e){if(c)for(var f=0;f<b.length;f++)c[f]=b[f];else c=b;var g=p(b,a),h=g[0],i=g[1];if(h==i)return c;q(c,0,h),q(c,1,0==i?h:i);var j=c[0],k=c[1],l=s(e,c,2,a-2,j,k,j,1)+1;return c.length=l,c};var t=f.fsqrt=Math.sqrt,u=f.fsin=Math.sin,v=f.fcos=Math.cos,w=f.facos=Math.acos,x=f.fatan2=Math.atan2,y=f.fmod=function(a,b){return a%b},z=f.fexp=Math.exp,A=f.fpow=Math.pow,B=f.ffloor=Math.floor,C=2.225074e-308,D=Math.PI,E=b.navigator&&-1!=b.navigator.userAgent.indexOf("Firefox"),F=f.fmax=E?Math.max:function(a,b){return a>b?a:b},G=f.fmin=E?Math.min:function(a,b){return b>a?a:b},H=f.fabs=function(a){return 0>a?-a:a},I=f.fclamp=function(a,b,c){return G(F(a,b),c)},J=function(a){return F(0,G(a,1))};f.flerp=function(a,b,c){return a*(1-c)+b*c},f.flerpconst=function(a,b,c){return a+I(b-a,-c,c)};var K=f.NO_GROUP=0,L=f.ALL_LAYERS=-1,M=function(a,b,c,d){this.a=a,this.b=b,this.c=c,this.d=d},N=f.Vect=function(a,b){this.x=a,this.y=b},O=f.v=function(a,b){return{x:a,y:b}},P=f.vzero=new N(0,0),Q=f.v.eql=function(a,b){return a.x==b.x&&a.y==b.y},R=f.v.add=function(a,b){return new N(a.x+b.x,a.y+b.y)},S=f.v.sub=function(a,b){return new N(a.x-b.x,a.y-b.y)},T=f.v.neg=function(a){return new N(-a.x,-a.y)},U=f.v.mult=function(a,b){return new N(a.x*b,a.y*b)},V=f.v.dot=function(a,b){return a.x*b.x+a.y*b.y},W=f.v.cross=function(a,b){return a.x*b.y-a.y*b.x},X=f.v.perp=function(a){return new N(-a.y,a.x)};f.v.rperp=function(a){return new N(a.y,-a.x)};var Y=f.v.project=function(a,b){var c=(a.x*b.x+a.y*b.y)/(b.x*b.x+b.y*b.y);return new N(b.x*c,b.y*c)};f.v.forangle=function(a){return new N(v(a),u(a))},f.v.toangle=function(a){return x(a.y,a.x)};var Z=f.v.rotate=function(a,b){return new N(a.x*b.x-a.y*b.y,a.x*b.y+a.y*b.x)},$=f.v.unrotate=function(a,b){return new N(a.x*b.x+a.y*b.y,a.y*b.x-a.x*b.y)},_=f.v.lengthsq=function(a){return a.x*a.x+a.y*a.y},ab=f.v.len=function(a){return t(a.x*a.x+a.y*a.y)},bb=f.v.lerp=function(a,b,c){var d=1-c;return new N(a.x*d+b.x*c,a.y*d+b.y*c)},cb=f.v.normalize=function(a){var b=t(a.x*a.x+a.y*a.y)+C;return new N(a.x/b,a.y/b)};f.v.normalize_safe=function(a){return cb(a)};var db=f.v.clamp=function(a,b){var c=a.x*a.x+a.y*a.y;if(c>b*b){var d=t(c)+C;return new N(a.x*b/d,a.y*b/d)}return a};f.v.lerpconst=function(a,b,c){return R(a,db(S(b,a),c))};var eb=f.v.dist=function(a,b){var c=a.x-b.x,d=a.y-b.y;return t(c*c+d*d)},fb=f.v.distsq=function(a,b){var c=a.x-b.x,d=a.y-b.y;return c*c+d*d};f.v.near=function(a,b,c){return fb(a,b)<c*c},M.prototype.transform=function(a){var b=this;return new N(a.x*b.a+a.y*b.b,a.x*b.c+a.y*b.d)};var gb=f.v.slerp=function(a,b,c){var d=V(cb(a),cb(b)),e=w(I(d,-1,1));if(.001>e)return bb(a,b,c);var f=1/u(e);return R(U(a,u((1-c)*e)*f),U(b,u(c*e)*f))};f.v.slerpconst=function(a,b,c){var d=V(cb(a),cb(b)),e=w(I(d,-1,1));return gb(a,b,G(c,e)/e)},f.v.str=function(a){return"("+a.x+", "+a.y+")"};var hb=f.Constraint=function(a,b){var c=this;c.a=a,c.b=b,c.space=null,c.next_a=null,c.next_b=null,c.maxForce=1/0,c.errorBias=A(.9,60),c.maxBias=1/0};hb.prototype.preSolve=g,hb.prototype.postSolve=g,hb.prototype.applyCachedImpulse=g;var ib=function(a,b){return(b-a.restAngle)*a.stiffness},jb=f.DampedRotarySpring=function(a,b,c,d,e){hb.apply(this,arguments);var f=this;f.restAngle=c,f.stiffness=d,f.damping=e,f.springTorqueFunc=ib,f.jAcc=0};i(hb,jb),jb.prototype.preStep=function(a){var b=this,c=b.a,d=b.b,e=c.i_inv+d.i_inv;b.iSum=1/e,b.w_coef=1-z(-b.damping*a*e),b.target_wrn=0;var f=b.springTorqueFunc(b,c.a-d.a)*a;b.jAcc=f,c.w-=f*c.i_inv,d.w+=f*d.i_inv},jb.prototype.applyImpulse=function(){var a=this,b=a.a,c=a.b,d=b.w-c.w,e=(a.target_wrn-d)*a.w_coef;a.target_wrn=d+e;var f=e*a.iSum;a.jAcc+=f,b.w+=f*b.i_inv,c.w-=f*c.i_inv},jb.prototype.getImpulse=function(){return this.jAcc};var kb=function(a,b){return(a.restLength-b)*a.stiffness},lb=f.DampedSpring=function(a,b,c,d,e,f,g){hb.apply(this,arguments);var h=this;h.anchr1=c,h.anchr2=d,h.restLength=e,h.stiffness=f,h.damping=g,h.springForceFunc=kb,h.jAcc=0};i(hb,lb),lb.prototype.preStep=function(a){var b=this,c=b.a,d=b.b;b.r1=Z(b.anchr1,c.rot),b.r2=Z(b.anchr2,d.rot);var e=S(R(d.p,b.r2),R(c.p,b.r1)),f=ab(e);b.n=U(e,1/(f?f:1/0));var g=Od(c,d,b.r1,b.r2,b.n);b.nMass=1/g,b.target_vrn=0,b.v_coef=1-z(-b.damping*a*g);var h=b.springForceFunc(b,f),i=b.jAcc=h*a;Md(c,d,b.r1,b.r2,U(b.n,i))},lb.prototype.applyImpulse=function(){var a=this,b=a.a,c=a.b,d=a.n,e=a.r1,f=a.r2,g=Kd(b,c,e,f,d),h=(a.target_vrn-g)*a.v_coef;a.target_vrn=g+h;var i=h*a.nMass;a.jAcc+=i,Md(b,c,a.r1,a.r2,U(a.n,i))},lb.prototype.getImpulse=function(){return this.jAcc};var mb=f.GearJoint=function(a,b,c,d){hb.apply(this,arguments);var e=this;e.phase=c,e.ratio=d,e.ratio_inv=1/d,e.jAcc=0};i(hb,mb),mb.prototype.preStep=function(a){var b=this,c=b.a,d=b.b;b.iSum=1/(c.i_inv*b.ratio_inv+b.ratio*d.i_inv);var e=b.maxBias;b.bias=I(-Qd(b.errorBias,a)*(d.a*b.ratio-c.a-b.phase)/a,-e,e)},mb.prototype.applyCachedImpulse=function(a){var b=this,c=b.a,d=b.b,e=b.jAcc*a;c.w-=e*c.i_inv*b.ratio_inv,d.w+=e*d.i_inv},mb.prototype.applyImpulse=function(a){var b=this,c=b.a,d=b.b,e=d.w*b.ratio-c.w,f=b.maxForce*a,g=(b.bias-e)*b.iSum,h=b.jAcc;b.jAcc=I(h+g,-f,f),g=b.jAcc-h,c.w-=g*c.i_inv*b.ratio_inv,d.w+=g*d.i_inv},mb.prototype.getImpulse=function(){var a=this;return H(a.jAcc)},mb.prototype.setRatio=function(a){var b=this;b.ratio=a,b.ratio_inv=1/a,b.activateBodies()};var nb=f.GrooveJoint=function(a,b,c,d,e){hb.apply(this,arguments);var f=this;f.grv_a=c,f.grv_b=d,f.grv_n=X(cb(S(d,c))),f.anchr2=e,f.jAcc=P};i(hb,nb),nb.prototype.preStep=function(a){var b=this,c=b.a,d=b.b,e=c.local2World(b.grv_a),f=c.local2World(b.grv_b),g=Z(b.grv_n,c.rot),h=V(e,g);b.grv_tn=g,b.r2=Z(b.anchr2,d.rot);var i=W(R(d.p,b.r2),g);i<=W(e,g)?(b.clamp=1,b.r1=S(e,c.p)):i>=W(f,g)?(b.clamp=-1,b.r1=S(f,c.p)):(b.clamp=0,b.r1=S(R(U(X(g),-i),U(g,h)),c.p)),b.k=Pd(c,d,b.r1,b.r2);var j=S(R(d.p,b.r2),R(c.p,b.r1));b.bias=db(U(j,-Qd(b.errorBias,a)/a),b.maxBias)},nb.prototype.applyCachedImpulse=function(a){var b=this,c=b.a,d=b.b;Md(c,d,b.r1,b.r2,U(b.jAcc,a))},nb.prototype.grooveConstrain=function(a,b){var c=this,d=c.grv_tn,e=c.clamp*W(a,d)>0?a:Y(a,d);return db(e,c.maxForce*b)},nb.prototype.applyImpulse=function(a){var b=this,c=b.a,d=b.b,e=b.r1,f=b.r2,g=Jd(c,d,e,f),h=b.k.transform(S(b.bias,g)),i=b.jAcc;b.jAcc=b.grooveConstrain(R(i,h),a),h=S(b.jAcc,i),Md(c,d,b.r1,b.r2,h)},nb.prototype.getImpulse=function(){return ab(this.jAcc)},nb.prototype.setGrooveA=function(a){var b=this;b.grv_a=a,b.grv_n=X(cb(S(b.grv_b,a))),b.activateBodies()},nb.prototype.setGrooveB=function(a){var b=this;b.grv_b=a,b.grv_n=X(cb(S(a,b.grv_a))),b.activateBodies()};var ob=f.PinJoint=function(a,b,c,d){hb.apply(this,arguments);var e=this;e.anchr1=c,e.anchr2=d;var f=a?R(a.p,Z(c,a.rot)):c,g=b?R(b.p,Z(d,b.rot)):d;e.dist=ab(S(g,f)),e.jnAcc=0};i(hb,ob),ob.prototype.preStep=function(a){var b=this,c=b.a,d=b.b;b.r1=Z(b.anchr1,c.rot),b.r2=Z(b.anchr2,d.rot);var e=S(R(d.p,b.r2),R(c.p,b.r1)),f=ab(e);b.n=U(e,1/(f?f:1/0)),b.nMass=1/Od(c,d,b.r1,b.r2,b.n);var g=b.maxBias;b.bias=I(-Qd(b.errorBias,a)*(f-b.dist)/a,-g,g)},ob.prototype.applyCachedImpulse=function(a){var b=this,c=b.a,d=b.b,e=U(b.n,b.jnAcc*a);Md(c,d,b.r1,b.r2,e)},ob.prototype.applyImpulse=function(a){var b=this,c=b.a,d=b.b,e=b.n,f=Kd(c,d,b.r1,b.r2,e),g=b.maxForce*a,h=(b.bias-f)*b.nMass,i=b.jnAcc;b.jnAcc=I(i+h,-g,g),h=b.jnAcc-i,Md(c,d,b.r1,b.r2,U(e,h))},ob.prototype.getImpulse=function(){return H(this.jnAcc)};var pb=f.PivotJoint=function(a,b,c,d){hb.apply(this,arguments);var e=this;if(!d){var f=c;c=a?a.world2Local(f):f,d=b?b.world2Local(f):f}e.anchr1=c,e.anchr2=d,e.jAcc=P};i(hb,pb),pb.prototype.preStep=function(a){var b=this,c=b.a,d=b.b;b.r1=Z(b.anchr1,c.rot),b.r2=Z(b.anchr2,d.rot),b.k=Pd(c,d,b.r1,b.r2);var e=S(R(d.p,b.r2),R(c.p,b.r1));b.bias=db(U(e,-Qd(b.errorBias,a)/a),b.maxBias)},pb.prototype.applyCachedImpulse=function(a){var b=this,c=b.a,d=b.b;Md(c,d,b.r1,b.r2,U(b.jAcc,a))},pb.prototype.applyImpulse=function(a){var b=this,c=b.a,d=b.b,e=b.r1,f=b.r2,g=Jd(c,d,e,f),h=b.k.transform(S(b.bias,g)),i=b.jAcc;b.jAcc=db(R(b.jAcc,h),b.maxForce*a),h=S(b.jAcc,i),Md(c,d,b.r1,b.r2,h)},pb.prototype.getImpulse=function(){return ab(this.jAcc)};var qb=f.RatchetJoint=function(a,b,c,d){hb.apply(this,arguments);var e=this;e.angle=0,e.phase=c,e.ratchet=d,e.angle=(b?b.a:0)-(a?a.a:0)};i(hb,qb),qb.prototype.preStep=function(a){var b=this,c=b.a,d=b.b,e=b.angle,f=b.phase,g=b.ratchet,h=d.a-c.a,i=e-h,j=0;i*g>0?j=i:b.angle=B((h-f)/g)*g+f,b.iSum=1/(c.i_inv+d.i_inv);var k=b.maxBias;b.bias=I(-Qd(b.errorBias,a)*j/a,-k,k),b.bias||(b.jAcc=0)},qb.prototype.applyCachedImpulse=function(a){var b=this,c=b.a,d=b.b,e=b.jAcc*a;c.w-=e*c.i_inv,d.w+=e*d.i_inv},qb.prototype.applyImpulse=function(a){var b=this;if(b.bias){var c=b.a,d=b.b,e=d.w-c.w,f=b.ratchet,g=b.maxForce*a,h=-(b.bias+e)*b.iSum,i=b.jAcc;b.jAcc=I((i+h)*f,0,g*H(f))/f,h=b.jAcc-i,c.w-=h*c.i_inv,d.w+=h*d.i_inv}},qb.prototype.getImpulse=function(){return H(this.jAcc)};var rb=f.RotaryLimitJoint=function(a,b,c,d){hb.apply(this,arguments);var e=this;return e.min=c,e.max=d,e};i(hb,rb),rb.prototype.preStep=function(a){var b=this,c=b.a,d=b.b,e=d.a-c.a,f=0;e>b.max?f=b.max-e:e<b.min&&(f=b.min-e),b.iSum=1/(1/c.i+1/d.i);var g=b.maxBias;b.bias=I(-Qd(b.errorBias,a)*f/a,-g,g),b.bias||(b.jAcc=0)},rb.prototype.applyCachedImpulse=function(a){var b=this,c=b.a,d=b.b,e=b.jAcc*a;c.w-=e*c.i_inv,d.w+=e*d.i_inv},rb.prototype.applyImpulse=function(a){var b=this;if(b.bias){var c=b.a,d=b.b,e=d.w-c.w,f=b.maxForce*a,g=-(b.bias+e)*b.iSum,h=b.jAcc;b.jAcc=b.bias<0?I(h+g,0,f):I(h+g,-f,0),g=b.jAcc-h,c.w-=g*c.i_inv,d.w+=g*d.i_inv}},rb.prototype.getImpulse=function(){return H(this.jAcc)};var sb=f.SimpleMotor=function(a,b,c){hb.apply(this,arguments);var d=this;d.rate=c,d.jAcc=0};i(hb,sb),sb.prototype.preStep=function(){var a=this,b=a.a,c=a.b;a.iSum=1/(b.i_inv+c.i_inv)},sb.prototype.applyCachedImpulse=function(a){var b=this,c=b.a,d=b.b,e=b.jAcc*a;c.w-=e*c.i_inv,d.w+=e*d.i_inv},sb.prototype.applyImpulse=function(a){var b=this,c=b.a,d=b.b,e=d.w-c.w+b.rate,f=b.maxForce*a,g=-e*b.iSum,h=b.jAcc;b.jAcc=I(h+g,-f,f),g=b.jAcc-h,c.w-=g*c.i_inv,d.w+=g*d.i_inv},sb.prototype.getImpulse=function(){return H(this.jAcc)};var tb=f.SlideJoint=function(a,b,c,d,e,f){hb.apply(this,arguments);var g=this;g.anchr1=c,g.anchr2=d,g.min=e,g.max=f,g.jnAcc=0};i(hb,tb),tb.prototype.preStep=function(a){var b=this,c=b.a,d=b.b;b.r1=Z(b.anchr1,c.rot),b.r2=Z(b.anchr2,d.rot);var e=S(R(d.p,b.r2),R(c.p,b.r1)),f=ab(e),g=0;f>b.max?(g=f-b.max,b.n=cb(e)):f<b.min?(g=b.min-f,b.n=T(cb(e))):(b.n=P,b.jnAcc=0),b.nMass=1/Od(c,d,b.r1,b.r2,b.n);var h=b.maxBias;b.bias=I(-Qd(b.errorBias,a)*g/a,-h,h)},tb.prototype.applyCachedImpulse=function(a){var b=this,c=b.a,d=b.b,e=U(b.n,b.jnAcc*a);Md(c,d,b.r1,b.r2,e)},tb.prototype.applyImpulse=function(a){var b=this;if(!Q(b.n,P)){var c=b.a,d=b.b,e=b.n,f=b.r1,g=b.r2,h=Jd(c,d,f,g),i=V(h,e),j=(b.bias-i)*b.nMass,k=b.jnAcc;b.jnAcc=I(k+j,-b.maxForce*a,0),j=b.jnAcc-k,Md(c,d,b.r1,b.r2,U(e,j))}},tb.prototype.getImpulse=function(){return H(this.jnAcc)};var ub=function(a,b,c,d){var e=this;e.p=a,e.n=b,e.dist=c,e.hash=d,e.r1=new N(0,0),e.r2=new N(0,0)};ub.prototype.jnAcc=0,ub.prototype.jtAcc=0,ub.prototype.jBias=0,ub.prototype.nMass=0,ub.prototype.tMass=0,ub.prototype.bounce=0,ub.prototype.bias=0;var vb=function(a,b){var c=a.threadForBody(b),d=c.prev,e=c.next;d?d.threadForBody(b).next=e:b.arbiterList==a&&(b.arbiterList=e),e&&(e.threadForBody(b).prev=d),c.prev=null,c.next=null},wb=function(a,b){this.next=a,this.prev=b},xb=f.Arbiter=function(a,b){var c=this;c.surface_vr=new N(0,0),c.a=a,c.body_a=a.body,c.b=b,c.body_b=b.body,c.thread_a=new wb(null,null),c.thread_b=new wb(null,null)};xb.prototype.handler=null,xb.prototype.swappedColl=!1,xb.prototype.e=0,xb.prototype.u=0,xb.prototype.stamp=0,xb.prototype.state=zb,xb.prototype.data=null,xb.prototype.reset=function(a,b){var c=this;c.handler=null,c.swappedColl=!1,c.e=0,c.u=0,c.surface_vr.x=c.surface_vr.y=0,c.contacts=null,c.a=a,c.body_a=a.body,c.b=b,c.body_b=b.body,c.thread_a.next=null,c.thread_a.prev=null,c.thread_b.next=null,c.thread_b.prev=null,c.stamp=0,c.state=zb,c.data=null},xb.prototype.unthread=function(){var a=this;vb(a,a.body_a),vb(a,a.body_b)},xb.prototype.isFirstContact=function(){return this.state==zb},xb.prototype.getCount=function(){return this.state!=Cb?this.contacts.length:0},xb.prototype.getNormal=function(a){var b=this;j(a>=0&&a<b.getCount(),"Index error: The specified contact index is invalid for this arbiter");var c=b.contacts[a].n;return b.swappedColl?T(c):c},xb.prototype.getPoint=function(a){return j(a>=0&&a<this.getCount(),"Index error: The specified contact index is invalid for this arbiter"),this.contacts[a].p},xb.prototype.getDepth=function(a){return j(a>=0&&a<this.getCount(),"Index error: The specified contact index is invalid for this arbiter"),this.contacts[a].dist},xb.prototype.getContactPointSet=function(){var a=this,b=new Eb;b.count=a.getCount();for(var c,d=0;d<b.count;d++)c=a.contacts[d],b.points[d]=new Db(c.p,c.n,c.dist);return b},xb.prototype.setContactPointSet=function(a){var b=this,c=a.count;j(c==b.contacts.length,"The number of contact points cannot be changed.");for(var d=0;c>d;d++)b.contacts[d].p=a.points[d].point,b.contacts[d].n=a.points[d].normal,b.contacts[d].dist=a.points[d].dist},xb.prototype.totalImpulse=function(){for(var a=this,b=a.contacts,c=P,d=0,e=a.getCount();e>d;d++){var f=b[d];c=R(c,U(f.n,f.jnAcc))}return a.swappedColl?c:T(c)},xb.prototype.totalImpulseWithFriction=function(){for(var a=this,b=a.contacts,c=P,d=0,e=a.getCount();e>d;d++){var f=b[d];c=R(c,Z(f.n,O(f.jnAcc,f.jtAcc)))}return a.swappedColl?c:T(c)},xb.prototype.totalKE=function(){for(var a=this,b=(1-a.e)/(1+a.e),c=0,d=a.contacts,e=0,f=a.getCount();f>e;e++){var g=d[e],h=g.jnAcc,i=g.jtAcc;c+=b*h*h/g.nMass+i*i/g.tMass}return c},xb.prototype.ignore=function(){this.state=Bb},xb.prototype.getSurfaceVelocity=function(){return U(this.surface_vr,this.swappedColl?-1:1)},xb.prototype.setSurfaceVelocity=function(a){this.surface_vr=U(a,this.swappedColl?-1:1)},xb.prototype.update=function(a,b,c,d){var e=this,f=a.length;if(e.contacts)for(var g=0;f>g;g++)for(var h=a[g],i=0,j=e.contacts.length;j>i;i++){var k=e.contacts[i];h.hash==k.hash&&(h.jnAcc=k.jnAcc,h.jtAcc=k.jtAcc)}e.contacts=a,e.handler=b,e.swappedColl=c.collision_type!=b.a,e.e=c.e*d.e,e.u=c.u*d.u;var l,m;f?(l=a[0].n.x,m=a[0].n.y):l=m=0;var n=c.surface_v.x-d.surface_v.x,o=c.surface_v.y-d.surface_v.y,p=n*l+o*m;e.surface_vr.x=n-l*p,e.surface_vr.y=o-m*p,e.a=c,e.body_a=c.body,e.b=d,e.body_b=d.body,e.state==Cb&&(e.state=zb)},xb.prototype.preStep=function(a,b,c){for(var d=this,e=d.body_a,f=d.body_b,g=0;g<d.contacts.length;g++){var h=d.contacts[g],i=h.r1,j=h.r2,k=h.n,l=h.p;i.x=l.x-e.p.x,i.y=l.y-e.p.y,j.x=l.x-f.p.x,j.y=l.y-f.p.y,h.nMass=1/Od(e,f,i,j,k),h.tMass=1/Od(e,f,i,j,X(k)),h.bias=-c*G(0,h.dist+b)/a,h.jBias=0,h.bounce=Kd(e,f,i,j,k)*d.e}},xb.prototype.applyCachedImpulse=function(a){var b=this;if(!b.isFirstContact())for(var c=b.body_a,d=b.body_b,e=0;e<b.contacts.length;e++){var f=b.contacts[e],g=f.n.x*f.jnAcc-f.n.y*f.jtAcc,h=f.n.x*f.jtAcc+f.n.y*f.jnAcc;Md(c,d,f.r1,f.r2,new N(g*a,h*a))}},xb.prototype.applyImpulse=function(){this._caches||(this._caches={});for(var a=this,b=a.body_a,c=a.body_b,d=a.surface_vr,e=a.u,f=0,g=a.contacts.length;g>f;f++){var h=a.contacts[f],i=h.nMass,j=h.n,k=h.r1,l=h.r2,m=[j.x,j.y,k,l,i].join("-");this._caches[m]||(this._caches[m]=1);var n=b.w_bias,o=c.w_bias,p=b.v_bias,q=c.v_bias,r=p.x,s=p.y,t=q.x,u=q.y,v=b.v,w=c.v,x=v.x,y=v.y,z=w.x,A=w.y,B=b.w,C=c.w,D=k.x,E=k.y,G=l.x,H=l.y,J=j.x,K=j.y,L=(t-H*o-r+E*n)*J+(u+G*o-s-D*n)*K,M=z-H*C-x+E*B+d.x,N=A+G*C-y-D*B+d.y,O=M*J+N*K,P=-M*K+N*J,Q=(h.bias-L)*i,R=h.jBias;h.jBias=F(R+Q,0);var S=-(h.bounce+O)*i,T=h.jnAcc;h.jnAcc=F(T+S,0);var U=e*h.jnAcc,V=-P*h.tMass,W=h.jtAcc;h.jtAcc=I(W+V,-U,U);var X=h.jBias-R,Y=J*X,Z=K*X,$=b.m_inv,_=b.i_inv;p.x=r-Y*$,p.y=s-Z*$,b.w_bias+=_*(-D*Z+E*Y);var ab=c.m_inv,bb=c.i_inv;q.x=t+Y*ab,q.y=u+Z*ab,c.w_bias+=bb*(G*Z-H*Y);var cb=h.jnAcc-T,db=h.jtAcc-W;Y=J*cb-K*db,Z=J*db+K*cb,v.x=x-Y*$,v.y=y-Z*$,b.w+=_*(-D*Z+E*Y),w.x=z+Y*ab,w.y=A+Z*ab,c.w+=bb*(G*Z-H*Y)}};var yb=function(a,b,c,d,e,f,g){this.a=a,this.b=b,this.begin=c,this.preSolve=d,this.postSolve=e,this.separate=f,this.data=g},zb=0,Ab=1,Bb=2,Cb=3;xb.prototype.getShapes=function(){return this.swappedColl?[this.b,this.a]:[this.a,this.b]},xb.prototype.getBodies=function(){var a=this.getShapes();return[a[0].body,a[1].body]};var Db=function(a,b,c){this.point=a,this.normal=b,this.dist=c},Eb=function(){this.count=0,this.points=[]},Fb=function(a,b){var c=a.indexOf(b);-1!=c&&(a[c]=a[a.length-1],a.pop())},Gb=f.BB=function(a,b,c,d){this.l=a,this.b=b,this.r=c,this.t=d},Hb=Gb.newForCircle=function(a,b){return new Gb(a.x-b,a.y-b,a.x+b,a.y+b)};Gb.prototype.intersects=function(a){var b=this;return b.l<=a.r&&a.l<=b.r&&b.b<=a.t&&a.b<=b.t},Gb.prototype.containsBB=function(a){var b=this;return b.l<=a.l&&b.r>=a.r&&b.b<=a.b&&b.t>=a.t},Gb.prototype.containsVect=function(a){var b=this;return b.l<=a.x&&b.r>=a.x&&b.b<=a.y&&b.t>=a.y},Gb.prototype.merge=function(a){var b=this;return new Gb(G(b.l,a.l),G(b.b,a.b),F(b.r,a.r),F(b.t,a.t))},Gb.prototype.expand=function(a){var b=this;return new Gb(G(b.l,a.x),G(b.b,a.y),F(b.r,a.x),F(b.t,a.y))},Gb.prototype.center=function(){var a=this;return bb(new N(a.l,a.b),new N(a.r,a.t),.5)},Gb.prototype.area=function(){var a=this;return(a.r-a.l)*(a.t-a.b)},Gb.prototype.mergedArea=function(a){var b=this;return(F(b.r,a.r)-G(b.l,a.l))*(F(b.t,a.t)-G(b.b,a.b))},Gb.prototype.segmentQuery=function(a,b){var c=this,d=1/(b.x-a.x),e=c.l==a.x?-1/0:(c.l-a.x)*d,f=c.r==a.x?1/0:(c.r-a.x)*d,g=G(e,f),h=F(e,f),i=1/(b.y-a.y),j=c.b==a.y?-1/0:(c.b-a.y)*i,k=c.t==a.y?1/0:(c.t-a.y)*i,l=G(j,k),m=F(j,k);if(h>=l&&m>=g){var n=F(g,l),o=G(h,m);if(o>=0&&1>=n)return F(n,0)}return 1/0},Gb.prototype.intersectsSegment=function(a,b){var c=this;return 1/0!=c.segmentQuery(a,b)},Gb.prototype.clampVect=function(a){var b=this;return new N(I(a.x,b.l,b.r),I(a.y,b.b,b.t))},Gb.prototype.wrapVect=function(a){var b=this,c=H(b.r-b.l),d=y(a.x-b.l,c),e=d>0?d:d+c,f=H(b.t-b.b),g=y(a.y-b.b,f),h=g>0?g:g+f;return new N(e+b.l,h+b.b)};var Ib=f.SpatialIndex=function(a,b){var c=this;c.bbfunc=a,c.staticIndex=b,b&&(j(!b.dynamicIndex,"This static index is already associated with a dynamic index."),b.dynamicIndex=c)},Jb=function(a,b,c,d){this.bbfunc=a,this.staticIndex=b,this.queryFunc=c,this.data=d},Kb=function(a,b){b.staticIndex.query(a,b.bbfunc(a),b.queryFunc,b.data)};Ib.prototype.collideStatic=function(a,b,c){var d=this;if(a&&a.count>0){var e=new Jb(d.bbfunc,a,b,c);d.each(Kb,e)}};var Lb=function(a,b){var c=this;c.bb=a.bb.merge(b.bb),c.parent=null,c.setA(a),c.setB(b)},Mb=function(a,b){this.bb=new Gb(0,0,0,0);var c=this;c.obj=b,a.getBB(b,c.bb),c.parent=null,c.STAMP=0,c.PAIRS=null},Nb=function(a,b,c,d,e){this.aPrev=null,this.aLeaf=a,this.aNext=b,this.bPrev=null,this.bLeaf=c,this.bNext=d,this.id=e},Ob=f.BBTree=function(a,b){var c=this;Ib.call(c,a,b),c.velocityFunc=null,c.leaves={},c.count=0,c.root=null,c.pooledNodes=null,c.pooledPairs=null,c.stamp=0};i(Ib,Ob),Ob.prototype.getBB=function(a,b){var c=this,d=c.bbfunc(a),e=c.velocityFunc;if(e){var f=.1,g=(d.r-d.l)*f,h=(d.t-d.b)*f,i=U(e(a),.1);b.l=d.l+G(-g,i.x),b.b=d.b+G(-h,i.y),b.r=d.r+F(g,i.x),b.t=d.t+F(h,i.y)}else b.l=d.l,b.b=d.b,b.r=d.r,b.t=d.t},Ob.prototype.getMasterTree=function(){return this.dynamicIndex||this},Ob.prototype.incrementStamp=function(){(this.dynamicIndex||this).stamp++},Nb.prototype.recycle=function(a){var b=this;a=a.getMasterTree(),b.aNext=a.pooledPairs,a.pooledPairs=b},Ob.prototype.pairFromPool=function(a,b,c,d,e){var f=this;f=f.getMasterTree();var g=f.pooledPairs;if(g)return f.pooledPairs=g.aNext,g.constructor(a,b,c,d,e),g;var h=new Nb(a,b,c,d,e);return h};var Pb=function(a,b,c){c&&(c.aLeaf==b?c.aPrev=a:c.bPrev=a),a?a.aLeaf==b?a.aNext=c:a.bNext=c:b.PAIRS=c};Mb.prototype.pairsClear=function(a){var b=this,c=b.PAIRS;for(b.PAIRS=null;c;){if(c.aLeaf==b){var d=c.aNext;Pb(c.bPrev,c.bLeaf,c.bNext)}else{var d=c.bNext;Pb(c.aPrev,c.aLeaf,c.aNext)}c.recycle(a),c=d}};var Qb=function(a,b,c){var d=a.PAIRS,e=b.PAIRS,f=c.pairFromPool(a,d,b,e,0);a.PAIRS=b.PAIRS=f,d&&(d.aLeaf==a?d.aPrev=f:d.bPrev=f),e&&(e.aLeaf==b?e.aPrev=f:e.bPrev=f)};Lb.prototype.recycle=function(a){var b=this;b.parent=a.pooledNodes,a.pooledNodes=b},Ob.prototype.nodeFromPool=function(a,b){var c=this,d=c.pooledNodes;if(d)return c.pooledNodes=d.parent,d.constructor(a,b),d;var e=new Lb(a,b);return e},Lb.prototype.setA=function(a){var b=this;b.A=a,a.parent=b},Lb.prototype.setB=function(a){var b=this;b.B=a,a.parent=b},Lb.prototype.isLeaf=!1,Mb.prototype.isLeaf=!0,Lb.prototype.other=function(a){var b=this;return b.A==a?b.B:b.A},Lb.prototype.replaceChild=function(a,b,c){var d=this;d.A==a?(d.A.recycle(c),d.setA(b)):(d.B.recycle(c),d.setB(b));for(var e=d;e;e=e.parent)e.bb=e.A.bb.merge(e.B.bb)};var Rb=function(a,b){return H(a.l+a.r-b.l-b.r)+H(a.b+a.t-b.b-b.t)},Sb=function(a,b,c){if(null==a)return b;if(a.isLeaf)return c.nodeFromPool(b,a);var d=a.B.bb.area()+a.A.bb.mergedArea(b.bb),e=a.A.bb.area()+a.B.bb.mergedArea(b.bb);return d==e&&(d=Rb(a.A.bb,b.bb),e=Rb(a.B.bb,b.bb)),d>e?a.setB(Sb(a.B,b,c)):a.setA(Sb(a.A,b,c)),a.bb=a.bb.merge(b.bb),a},Tb=function(a,b,c,d,e){a.bb.intersects(c)&&(a.isLeaf?d(b,a.obj,0,e):(Tb(a.A,b,c,d,e),Tb(a.B,b,c,d,e)))},Ub=function(a,b,c,d,e,f,g){if(a.isLeaf)return f(b,a.obj,g);var h=a.A.bb.segmentQuery(c,d),i=a.B.bb.segmentQuery(c,d);return i>h?(e>h&&(e=G(e,Ub(a.A,b,c,d,e,f,g))),e>i&&(e=G(e,Ub(a.B,b,c,d,e,f,g)))):(e>i&&(e=G(e,Ub(a.B,b,c,d,e,f,g))),e>h&&(e=G(e,Ub(a.A,b,c,d,e,f,g)))),e};Ob.prototype.subtreeRecycle=function(a){var b=this;a.isLeaf||(b.subtreeRecycle(a.A),b.subtreeRecycle(a.B),a.recycle(b))};var Vb=function(a,b,c){if(b==a)return null;var d=b.parent;if(d==a){var e=a.other(b);return e.parent=a.parent,a.recycle(c),e}return d.parent.replaceChild(d,d.other(b),c),a};Lb.prototype.markLeafQuery=function(a,b,c,d,e){var f=this;a.bb.intersects(f.bb)&&(f.A.markLeafQuery(a,b,c,d,e),f.B.markLeafQuery(a,b,c,d,e))},Mb.prototype.markLeafQuery=function(a,b,c,d,e){var f=this;a.bb.intersects(f.bb)&&(b?Qb(a,f,c):(f.STAMP<a.STAMP&&Qb(f,a,c),d(a.obj,f.obj,0,e)))},Mb.prototype.markSubtree=function(a,b,c,d){var e=this;if(e.STAMP==a.getMasterTree().stamp){b&&b.markLeafQuery(e,!1,a,c,d);for(var f=e;f.parent;f=f.parent)f==f.parent.A?f.parent.B.markLeafQuery(e,!0,a,c,d):f.parent.A.markLeafQuery(e,!1,a,c,d)}else for(var g=e.PAIRS;g;)e==g.bLeaf?(g.id=c(g.aLeaf.obj,e.obj,g.id,d),g=g.bNext):g=g.aNext},Lb.prototype.markSubtree=function(a,b,c,d){this.A.markSubtree(a,b,c,d),this.B.markSubtree(a,b,c,d)},Mb.prototype.update=function(a){var b=this,c=a.root,d=a.bbfunc(b.obj);return b.bb.containsBB(d)?!1:(a.getBB(b.obj,b.bb),c=Vb(c,b,a),a.root=Sb(c,b,a),b.pairsClear(a),b.STAMP=a.getMasterTree().stamp,!0)};var Wb=function(a,b,c){return c};Mb.prototype.addPairs=function(a){var b=this,c=a.dynamicIndex;if(c){var d=c.root;if(d){var e=c;d.markLeafQuery(b,!0,e,g,null)}}else{var f=a.staticIndex.root;b.markSubtree(a,f,Wb,null)}},Ob.prototype.setVelocityFunc=function(a){this.velocityFunc=a},Ob.prototype.insert=function(a,b){var c=this,d=c.leaves[b]=new Mb(c,a),e=c.root;c.root=Sb(e,d,c),c.count++,d.STAMP=c.getMasterTree().stamp,d.addPairs(c),c.incrementStamp()},Ob.prototype.remove=function(a,b){var c=this,d=c.leaves[b];delete c.leaves[b],c.root=Vb(c.root,d,c),c.count--,d.pairsClear(c)},Ob.prototype.contains=function(a,b){return null!=this.leaves[b]},Ob.prototype.reindexQuery=function(a,b){var c=this;if(c.root){for(var d in c.leaves)c.leaves[d].update(c);var e=c.staticIndex,f=e&&e.root;c.root.markSubtree(c,f,a,b),e&&!f&&c.collideStatic(e,a,b),c.incrementStamp()}},Ob.prototype.reindex=function(){this.reindexQuery(Wb,null)},Ob.prototype.reindexObject=function(a,b){var c=this,d=c.leaves[b];d&&(d.update(c)&&d.addPairs(c),c.incrementStamp())},Ob.prototype.segmentQuery=function(a,b,c,d,e,f){var g=this,h=g.root;h&&Ub(h,a,b,c,d,e,f)},Ob.prototype.query=function(a,b,c,d){this.root&&Tb(this.root,a,b,c,d)},Ob.prototype.each=function(a,b){var c=this;for(var d in c.leaves)a(c.leaves[d].obj,b)};var Xb=f.Body=function(a,b){var c=this;c.p=O(0,0),c.v=O(0,0),c.f=O(0,0),c.v_bias=new N(0,0),this.rot=new N(1,0),c.setMass(a),c.setMoment(b)};Xb.prototype={space:null,shapeList:null,arbiterList:null,constraintList:null,nodeRoot:null,nodeNext:null,nodeIdleTime:0,w:0,t:0,w_bias:0,v_limit:1/0,w_limit:1/0,data:null,a:0},Xb.prototype.getPos=function(){return this.p},Xb.prototype.getAngVel=function(){return this.w},Xb.prototype.getVel=function(){return this.v},Xb.prototype.setVel=function(a){this.activate(),this.v=a},Xb.prototype.setAngVel=function(a){this.activate(),this.w=a},Xb.initStatic=function(a){return a.setMass(1/0),a.setMoment(1/0),a.nodeIdleTime=1/0,a},Xb.newStatic=function(){var a=new Xb(1/0,1/0);return a.nodeIdleTime=1/0,a};Xb.prototype.setMass=function(a){var b=this;j(a>0,"Mass must be positive and non-zero."),b.activate(),b.m=a,b.m_inv=1/a},Xb.prototype.setMoment=function(a){var b=this;j(a>0,"Moment of Inertia must be positive and non-zero."),b.activate(),b.i=a,b.i_inv=1/a},Xb.prototype.addShape=function(a){var b=this,c=b.shapeList;c&&(c.prev=a),a.next=c,b.shapeList=a},Xb.prototype.removeShape=function(a){var b=this,c=a.prev,d=a.next;c?c.next=d:b.shapeList=d,d&&(d.prev=c),a.prev=null,a.next=null};var Yb=function(a,b,c){return a==c?a.next(b):(a.a==b?a.next_a=Yb(a.next_a,b,c):a.next_b=Yb(a.next_b,b,c),a)};Xb.prototype.removeConstraint=function(a){var b=this;b.constraintList=Yb(b.constraintList,b,a)},Xb.prototype.setPos=function(a){var b=this;b.activate(),b.p=a};var Zb=function(a,b){k(b==b&&1/0!=H(b),"Body's angle is invalid."),a.a=b,a.rot.x=v(b),a.rot.y=u(b)};Xb.prototype.setAngle=function(a){var b=this;b.activate(),Zb(b,a)},Xb.prototype.updateVelocity=function(a,b,c){var d=this,e=d.v;e.x=e.x*b+(a.x+d.f.x*d.m_inv)*c,e.y=d.v.y*b+(a.y+d.f.y*d.m_inv)*c;var f=d.v_limit;if(1/0>f){var g=e.x*e.x+e.y*e.y;if(g>f*f){var h=t(g)+C;e.x*=f/h,e.y*=f/h}}var i=d.w_limit;d.w=I(d.w*b+d.t*d.i_inv*c,-i,i)},Xb.prototype.updatePosition=function(a){var b=this;b.p.x+=(b.v.x+b.v_bias.x)*a,b.p.y+=(b.v.y+b.v_bias.y)*a,Zb(b,b.a+(b.w+b.w_bias)*a),b.v_bias.x=b.v_bias.y=0,b.w_bias=0},Xb.prototype.resetForces=function(){var a=this;a.activate(),a.f.x=a.f.y=0,a.t=0},Xb.prototype.applyForce=function(a,b){var c=this;c.activate(),c.f.x+=a.x,c.f.y+=a.y,c.t+=W(b,a)},Xb.prototype.applyImpulse=function(a,b){var c=this;c.activate(),Ld(c,a,b)},Xb.prototype.getVelAtPoint=function(a){var b=this;return R(b.v,U(X(a),b.w))},Xb.prototype.getVelAtWorldPoint=function(a){var b=this;return b.getVelAtPoint(S(a,b.p))},Xb.prototype.getVelAtLocalPoint=function(a){var b=this;return b.getVelAtPoint(Z(a,b.rot))},Xb.prototype.kScalar=function(a,b){return Nd(this,a,b)},Xb.prototype.eachShape=function(a,b){for(var c=this,d=c.shapeList;d;){var e=d.next;a(c,d,b),d=e}},Xb.prototype.eachConstraint=function(a,b){for(var c=this,d=c.constraintList;d;){var e=d.next(c);a(c,d,b),d=e}},Xb.prototype.eachArbiter=function(a,b){for(var c=this,d=c.arbiterList;d;){var e=d.next(c);d.swappedColl=c==d.body_b,a(c,d,b),d=e}};var $b=1,_b=30,ac=30,bc=function(a,b,c,d,e,f){var g=c+d,h=S(b,a),i=_(h);if(g*g>i){var j=t(i),k=j?U(h,1/j):O(1,0);return f.push(new ub(bb(a,b,c/(c+d)),k,j-g,e)),1}return 0},cc=function(a,b){for(var c=-1/0,d=0,e=0,f=a.length;f>e;e++){var g=a[e],h=V(g,b);h>c&&(c=h,d=e)}return d},dc=function(a,b){this.p=a,this.id=b},ec=function(a){return new dc(a.tc,0)},fc=function(a,b){return V(a.ta,b)>V(a.tb,b)?new dc(a.ta,0):new dc(a.tb,1)},gc=function(a,b){var c=a.tVerts,d=cc(c,b);return new dc(c[d],d)},hc=function(a,b){this.a=a.p,this.b=b.p,this.ab=S(b.p,a.p),this.id=(255&a.id)<<8|255&b.id},ic=function(a,b,c,d){this.shape1=a,this.shape2=b,this.func1=c,this.func2=d},jc=function(a,b){var c=a.func1(a.shape1,T(b)),d=a.func2(a.shape2,b);return new hc(c,d)},kc=function(a,b){this.p=a,this.hash=b},lc=function(a,b,c,d){this.a=a,this.b=b,this.r=c,this.n=d},mc=function(a,b){var c=a.verts.length,d=cc(a.tVerts,b),e=(d-1+c)%c,f=(d+1)%c,g=a.tVerts;if(V(b,a.tPlanes[d].n)>V(b,a.tPlanes[f].n)){var h=new lc(new kc(g[e],l(a.hashid,e)),new kc(g[d],l(a.hashid,d)),a.r,a.tPlanes[d].n);return h}var h=new lc(new kc(g[d],l(a.hashid,d)),new kc(g[f],l(a.hashid,f)),a.r,a.tPlanes[f].n);return h},nc=function(a,b){if(V(a.tn,b)>0){var c=new lc(new kc(a.ta,l(a.hashid,0)),new kc(a.tb,l(a.hashid,1)),a.r,a.tn);return c}var c=new lc(new kc(a.tb,l(a.hashid,1)),new kc(a.ta,l(a.hashid,0)),a.r,T(a.tn));return c},oc=function(a,b){var c=S(b,a);return-I(V(c,R(a,b))/_(c),-1,1)},pc=function(a,b,c){var d=.5*c;return R(U(a,.5-d),U(b,.5+d))},qc=function(a,b){var c=oc(a.ab,b.ab),d=pc(a.ab,b.ab,c),e=pc(a.a,b.a,c),f=pc(a.b,b.b,c),g=(65535&a.id)<<16|65535&b.id,h=S(b.ab,a.ab),i=cb(X(h)),j=-V(i,d);0>=j||c>0&&1>c?i=T(i):(j=ab(d),i=U(d,1/(j+C))),this.a=e,this.b=f,this.n=i,this.d=j,this.id=g},rc=function(a,b){return _(pc(a,b,oc(a,b)))},sc=function(a,b,c,d){for(var e=0,f=1/0,g=0,h=b-1;b>g;h=g,g++){var i=rc(c[h].ab,c[g].ab);f>i&&(f=i,e=h)}var j=c[e],k=c[(e+1)%b],l=jc(a,X(S(k.ab,j.ab))),m=W(S(k.ab,j.ab),R(S(l.ab,j.ab),S(l.ab,k.ab)));if(m>0&&ac>d){var n=1,o=new Array(b+1);o[0]=l;for(var h=0;b>h;h++){var p=(e+1+h)%b,q=o[n-1].ab,r=c[p].ab,s=(b>h+1?c[(p+1)%b]:l).ab;W(S(s,q),S(r,q))>0&&(o[n]=c[p],n++)}return sc(a,n,o,d+1)}return new qc(j,k)},tc=function(a,b,c,d){var e=[b,c,d];return sc(a,3,e,1)},uc=function(a,b,c,d){if(d>_b)return new qc(b,c);var e=S(c.ab,b.ab);if(W(e,R(b.ab,c.ab))>0)return uc(a,c,b,d+1);var f=oc(b.ab,c.ab),g=f>-1&&1>f?X(e):T(pc(b.ab,c.ab,f)),h=jc(a,g);return W(S(c.ab,h.ab),R(c.ab,h.ab))>0&&W(S(b.ab,h.ab),R(b.ab,h.ab))<0?tc(a,b,h,c):V(h.ab,g)<=F(V(b.ab,g),V(c.ab,g))?new qc(b,c):rc(b.ab,h.ab)<rc(h.ab,c.ab)?uc(a,b,h,d+1):uc(a,h,c,d+1)},vc=function(a,b){switch(a.type){case Lc:return new dc(a.tc,0);case Mc:var c=a;return new dc(0==b?c.ta:c.tb,b);case Nc:var d=a,e=b<d.verts.length?b:0;return new dc(d.tVerts[e],e);default:return new dc(P,0)}},wc=function(a,b){var c,d,e=b.id;if(e&&$b)c=new hc(vc(a.shape1,255&e>>24),vc(a.shape2,255&e>>16)),d=new hc(vc(a.shape1,255&e>>8),vc(a.shape2,255&e));else{var f=X(S(a.shape1.bb.center(),a.shape2.bb.center()));
c=jc(a,f),d=jc(a,T(f))}var g=uc(a,c,d,1);return b.id=g.id,g},xc=function(a,b,c,d,e,f,g,h){var i=d+e,j=i>0?d/i:.5,k=bb(b,c,j);h.push(new ub(k,f,a-i,g))},yc=function(a,b,c,d,e,f,g,h,i){var j=W(b,f),k=W(c,f),l=W(a,f),m=1-J((k-l)/(k-j)),n=bb(b,c,m),o=V(S(n,a),f);if(m>0&&0>=o){var p=d+e,q=p>0?e*(1-(p+o)/p):-.5*o;return i.push(new ub(R(n,U(f,q)),g,o,h)),1}return 0},zc=function(a,b,c,d,e){var f=U(b.n,b.r),g=U(a.n,a.r),h=R(b.a.p,f),i=R(b.b.p,f),j=Ed(b.a.p,a.a.p,a.b.p),k=Ed(b.b.p,a.a.p,a.b.p),m=U(c.n,d*c.d),n=fb(S(b.a.p,j),m),o=fb(S(b.b.p,k),m),p=l(b.a.hash,a.b.hash),q=l(b.b.hash,a.a.hash);if(o>n){var r=R(a.a.p,g);return xc(c.d,j,b.a.p,a.r,b.r,c.n,p,e),yc(r,h,i,a.r,b.r,a.n,c.n,q,e)+1}var r=R(a.b.p,g);return xc(c.d,k,b.b.p,a.r,b.r,c.n,q,e),yc(r,i,h,a.r,b.r,a.n,c.n,p,e)+1},Ac=function(a,b,c,d){var e=a.r+b.r;if(c.d<=e){var f=V(a.n,c.n)+V(b.n,c.n);return 0!=f&&f>0||0==f&&fb(a.a.p,a.b.p)>fb(b.a.p,b.b.p)?zc(a,b,c,1,d):zc(b,a,c,-1,d)}return 0},Bc=function(a,b,c,d){return bc(a.tc,b.tc,a.r,b.r,0,d)},Cc=function(a,b,c,d){var e=b.ta,f=b.tb,g=a.tc,h=S(f,e),i=J(V(h,S(g,e))/_(h)),j=R(e,U(h,i));if(bc(g,j,a.r,b.r,0,d)){var k=d[0].n;if((0!=i||V(k,Z(b.a_tangent,b.body.rot))>=0)&&(1!=i||V(k,Z(b.b_tangent,b.body.rot))>=0))return 1}return 0},Dc=function(a,b,c,d){var e=new ic(a,b,fc,fc),f=wc(e,c),g=f.n,h=a.body.rot,i=b.body.rot;return f.d<=a.r+b.r&&(!Q(f.a,a.ta)||V(g,Z(a.a_tangent,h))<=0)&&(!Q(f.a,a.tb)||V(g,Z(a.b_tangent,h))<=0)&&(!Q(f.b,b.ta)||V(g,Z(b.a_tangent,i))>=0)&&(!Q(f.b,b.tb)||V(g,Z(b.b_tangent,i))>=0)?Ac(nc(a,g),nc(b,T(g)),f,d):0},Ec=function(a,b,c,d){var e=new ic(a,b,gc,gc),f=wc(e,c);return f.d-a.r-b.r<=0?Ac(mc(a,f.n),mc(b,T(f.n)),f,d):0},Fc=function(a,b,c,d){var e=new ic(a,b,fc,gc),f=wc(e,c),g=f.n,h=a.body.rot;return f.d-a.r-b.r<=0&&(!Q(f.a,a.ta)||V(g,Z(a.a_tangent,h))<=0)&&(!Q(f.a,a.tb)||V(g,Z(a.b_tangent,h))<=0)?Ac(nc(a,g),mc(b,T(g)),f,d):0},Gc=function(a,b,c,d){var e=new ic(a,b,ec,gc),f=wc(e,c),g=a.r+b.r;if(f.d-g<=0){var h=bb(f.a,f.b,a.r/g);return d.push(new ub(h,f.n,f.d-g,0)),1}return 0},Hc=[Bc,null,null,Cc,null,null,Gc,Fc,Ec],Ic=Hc,Jc=[Bc,null,null,Cc,Dc,null,Gc,Fc,Ec];f.enableSegmentToSegmentCollisions=function(){Ic=Jc};var Kc=function(a,b,c,d){var e=Ic[a.type+b.type*Oc],f=e?e(a,b,c,d):0;return f},Lc=f.CIRCLE_SHAPE=0,Mc=f.SEGMENT_SHAPE=1,Nc=f.POLY_SHAPE=2,Oc=3,Pc=function(a,b,c,d){this.shape=a,this.p=b,this.d=c,this.g=d},Qc=function(a,b,c){this.shape=a,this.t=b,this.n=c};Qc.prototype.hitPoint=function(a,b){return bb(a,b,this.t)},Qc.prototype.hitDist=function(a,b){return eb(a,b)*this.t};var Rc=0,Sc=f.Shape=function(a){var b=this;b.hashid=Rc,Rc++,b.body=a,b.surface_v=new N(0,0),b.bb=new Gb(0,0,0,0)};Sc.prototype.sensor=0,Sc.prototype.e=0,Sc.prototype.u=0,Sc.prototype.collision_type=0,Sc.prototype.group=K,Sc.prototype.layers=L,Sc.prototype.data=null,Sc.prototype.space=null,Sc.prototype.next=null,Sc.prototype.prev=null,Sc.prototype.setElasticity=function(a){this.e=a},Sc.prototype.setFriction=function(a){this.body.activate(),this.u=a},Sc.prototype.getFriction=function(){return this.u},Sc.prototype.setLayers=function(a){this.body.activate(),this.layers=a},Sc.prototype.setSensor=function(a){this.body.activate(),this.sensor=a},Sc.prototype.setCollisionType=function(a){this.body.activate(),this.collision_type=a},Sc.prototype.getBody=function(){return this.body},Sc.prototype.getBB=function(){return this.bb},Sc.prototype.setBody=function(a){var b=this;j(!b.active(),"You cannot change the body on an active shape. You must remove the shape from the space before changing the body."),b.body=a},Sc.prototype.cacheBB=function(){var a=this,b=a.body;return a.update(b.p,b.rot)},Sc.prototype.update=function(a,b){var c=this;return c.cacheData(a,b),c.bb},Sc.prototype.pointQuery=function(a){var b=this,c=b.nearestPointQuery(a);return c&&c.d<0},Sc.prototype.segmentQuery=function(a,b,c){var d=this,e=d.nearestPointQuery(d,a);if(e){if(e.d<=0){var f=cb(S(a,e.p));return new Qc(d,0,f)}return d.segmentQuery(d,a,b,c)}};var Tc=f.CircleShape=function(a,b,c){var d=this;d.c=c,d.r=b,d.tc=new N(0,0),Sc.apply(this,arguments)};i(Sc,Tc),Tc.prototype.type=Lc,Tc.prototype.cacheData=function(a,b){var c=this,d=c.bb,e=c.r,f=c.c.x,g=c.c.y,h=c.tc.x=a.x+f*b.x-g*b.y,i=c.tc.y=a.y+f*b.y+g*b.x;return d.l=h-e,d.b=i-e,d.r=h+e,d.t=i+e,d},Tc.prototype.nearestPointQuery=function(a){var b=this,c=S(a,b.tc),d=ab(c),e=b.r,a=R(b.tc,U(c,e/d)),d=d-e,f=d>Dd?U(c,1/d):O(0,1);return new Pc(b,a,d,f)},Tc.prototype.segmentQuery=function(a,b){var c=this;return Fd(c,c.tc,c.r,a,b)};var Uc=f.SegmentShape=function(a,b,c,d){var e=this;e.a=b,e.b=c,e.n=X(cb(S(c,b))),e.r=d,e.a_tangent=new N(0,0),e.b_tangent=new N(0,0),Sc.apply(this,arguments)};i(Sc,Uc),Uc.prototype.type=Mc,Uc.prototype.cacheData=function(a,b){var c=this;c.ta=R(a,Z(c.a,b)),c.tb=R(a,Z(c.b,b)),c.tn=Z(c.n,b);var d,e,f,g;c.ta.x<c.tb.x?(d=c.ta.x,e=c.tb.x):(d=c.tb.x,e=c.ta.x),c.ta.y<c.tb.y?(f=c.ta.y,g=c.tb.y):(f=c.tb.y,g=c.ta.y);var h=c.r,i=c.bb;return i.l=d-h,i.b=f-h,i.r=e+h,i.t=g+h,i},Uc.prototype.nearestPointQuery=function(a){var b=this,c=Ed(a,b.ta,b.tb),d=S(a,c),e=ab(d),f=b.r,g=U(d,1/e),a=e?R(c,U(g,f)):c,e=e-f,g=e>Dd?g:b.n;return new Pc(b,a,e,g)},Uc.prototype.segmentQuery=function(a,b){var c=this,d=c.tn,e=V(S(c.ta,a),d),f=c.r,g=e>0?T(d):d,h=S(U(g,f),a),i=R(c.ta,h),j=R(c.tb,h),k=S(b,a);if(W(k,i)*W(k,j)<=0){var l=e+(e>0?-f:f),m=-l,n=V(k,d)-l;if(0>m*n)return{shape:c,t:m/(m-n),n:g}}else if(0!=f){var o=Fd(c,c.ta,c.r,a,b,o),p=Fd(c,c.tb,c.r,a,b,p);return o&&p?o.t<p.t?o:p:o||p}},Uc.prototype.setNeighbors=function(a,b){var c=this;c.a_tangent.x=a.x-c.a.x,c.a_tangent.y=a.y-c.a.y,c.b_tangent.x=b.x-c.b.x,c.b_tangent.y=b.y-c.b.y},Tc.setRadius=function(a){var b=this;b.r=a},Tc.prototype.setOffset=function(a){this.c=a},Uc.prototype.setEndpoints=function(a,b){var c=this;c.a=a,c.b=b,c.n=X(cb(S(b,a)))},Uc.prototype.setRadius=function(a){this.r=a};var Vc=f.PolyShape=function(a,b,c){Yc.call(this,a,b,c,0)};i(Sc,Vc),Vc.prototype.type=Nc,Vc.prototype.transformVerts=function(a,b){for(var c=this,d=c.verts,e=c.tVerts,f=1/0,g=-1/0,h=1/0,i=-1/0,j=0;j<d.length;j++){var k=R(a,Z(d[j],b));e[j]=k,f=G(f,k.x),g=F(g,k.x),h=G(h,k.y),i=F(i,k.y)}var l=c.r,m=this.bb;m.l=f-l,m.b=h-l,m.r=g+l,m.t=i+l},Vc.prototype.transformAxes=function(a,b){for(var c=this,d=c.planes,e=c.tPlanes,f=0;f<d.length;f++){var g=Z(d[f].n,b);e[f].n=g,e[f].d=V(a,g)+d[f].d}},Vc.prototype.cacheData=function(a,b){var c=this;return c.transformAxes(a,b),c.transformVerts(a,b)},Vc.prototype.nearestPointQuery=function(a){for(var b=this,c=b.verts.length,d=b.tPlanes,e=b.tVerts,f=b.r,g=e[c-1],h=1/0,i=P,j=P,k=!1,l=0;c>l;l++){d[l].compare(a)>0&&(k=!0);var m=e[l],n=Ed(a,g,m),o=eb(a,n);h>o&&(h=o,i=n,j=d[l].n),g=m}var o=k?h:-h,p=U(S(a,i),1/o),a=R(i,U(p,f)),q=o-f;return p=h>Dd?p:j,new Pc(b,a,q,p)},Vc.prototype.segmentQuery=function(a,b){for(var c,d=this,e=d.tPlanes,f=d.tVerts,g=d.verts.length,h=d.r,i=0;g>i;i++){var j=e[i].n,k=V(a,j),l=e[i].d+h-k;if(!(l>0)){var m=V(b,j),n=l/(m-k);if(!(0>n||n>1)){var o=bb(a,b,n),p=-W(j,o),q=-W(j,f[(i-1+g)%g]),r=-W(j,f[i]);p>=q&&r>=p&&(c=new Qc(d,n,j))}}}if(h>0)for(var i=0;g>i;i++){var s=Fd(d,f[i],h,a,b);s&&(!c||s.t<c.t)&&(c=s)}return c};var Wc=function(a){for(var b=a.length,c=0;b>c;c++){var d=a[c],e=a[(c+1)%b],f=a[(c+2)%b];if(W(S(e,d),S(f,d))>0)return!1}return!0};Vc.prototype.getNumVerts=function(){return this.verts.length},Vc.prototype.getVert=function(a){var b=this;return j(a>=0&&a<b.getNumVerts(),"Index out of range."),b.verts[a]},Vc.prototype.getRadius=function(){return this.r};var Xc=function(a,b,c){j(Wc(b),"Polygon is concave or has a reversed winding. Consider using cp.convexHull()."),a.verts=[],a.planes=[],a.tVerts=[],a.tPlanes=[];for(var d=b.length,e=0;d>e;e++)a.verts[e]=R(c,b[e]);for(e=0;e<b.length;e++)a.planes[e]=Hd(a.verts[(e-1+d)%d],a.verts[e]),a.tPlanes[e]=new Gd(O(0,0),0)};Vc.prototype.setVerts=function(a,b){var c=this;Xc(c,a,b)},Vc.prototype.setRadius=function(a){this.r=a};var Yc=f.PolyShape2=function(a,b,c,d){var e=this;Xc(e,b,c),Sc.call(e,a),e.r=d},Zc=f.BoxShape=function(a,b,c){var d=b/2,e=c/2;$c.call(this,a,new Gb(-d,-e,d,e))},$c=f.BoxShape2=function(a,b){_c.call(this,a,b,0)},_c=f.BoxShape3=function(a,b,c){var d=[O(b.l,b.b),O(b.l,b.t),O(b.r,b.t),O(b.r,b.b)];Yc.call(this,a,d,P,c)};i(Vc,Yc),i(Vc,Zc),i(Vc,$c),i(Vc,_c);var ad=function(){return 1},bd=function(a){return a.body.v},cd=function(a){return a.bb},dd=new yb(0,0,ad,ad,g,g,null),ed=f.Space=function(){var a=this;return a.iterations=10,a.gravity=P,a.damping=1,a.collisionSlop=.1,a.collisionBias=A(.9,60),a.collisionPersistence=3,a.locked=0,a.curr_dt=0,a.stamp=0,a.staticShapes=new Ob(cd,null),a.activeShapes=new Ob(cd,a.staticShapes),a.activeShapes.setVelocityFunc(bd),a.bodies=[],a.sleepingComponents=[],a.rousedBodies=[],a.sleepTimeThreshold=1/0,a.idleSpeedThreshold=0,a.enableContactGraph=!1,a.arbiters=[],a.pooledArbiters=[],a.contactBuffersHead=null,a.cachedArbiters={},a.constraints=[],a.defaultHandler=dd,a.collisionHandlers={},a.postStepCallbacks=[],a.skipPostStep=!1,a.staticBody=new Xb(1/0,1/0),a.staticBody.nodeIdleTime=1/0,a};ed.prototype.setIterations=function(a){this.iterations=a},ed.prototype.getCurrentTimeStep=function(){return this.curr_dt};var fd=function(a){j(!a.locked,"This operation cannot be done safely during a call to cpSpaceStep() or during a query. Put these calls into a post-step callback.")};ed.prototype.addCollisionHandler=function(a,b,c,d,e,f,h){var i=this;fd(i),i.removeCollisionHandler(a,b);var j=new yb(a,b,c?c:ad,d?d:ad,e?e:g,f?f:g,h);i.collisionHandlers[l(a,b)]=j},ed.prototype.removeCollisionHandler=function(a,b){var c=this;fd(c),delete c.collisionHandlers[l(a,b)]},ed.prototype.setDefaultCollisionHandler=function(a,b,c,d,e){var f=this;fd(f);var h=new yb(0,0,a?a:ad,b?b:ad,c?c:g,d?d:g,e);f.defaultHandler=h},ed.prototype.addShape=function(a){var b=this,c=a.body;return c.isStatic()?b.addStaticShape(a):(j(a.space!=b,"You have already added this shape to this space. You must not add it a second time."),j(!a.space,"You have already added this shape to another space. You cannot add it to a second."),fd(b),c.activate(),c.addShape(a),a.update(c.p,c.rot),b.activeShapes.insert(a,a.hashid),a.space=b,a)},ed.prototype.addStaticShape=function(a){var b=this;j(a.space!=b,"You have already added this shape to this space. You must not add it a second time."),j(!a.space,"You have already added this shape to another space. You cannot add it to a second."),j(a.body.isRogue(),"You are adding a static shape to a dynamic body. Did you mean to attach it to a static or rogue body? See the documentation for more information."),fd(b);var c=a.body;return c.addShape(a),a.update(c.p,c.rot),b.staticShapes.insert(a,a.hashid),a.space=b,a},ed.prototype.addBody=function(a){var b=this;return j(!a.isStatic(),"Do not add static bodies to a space. Static bodies do not move and should not be simulated."),j(a.space!=b,"You have already added this body to this space. You must not add it a second time."),j(!a.space,"You have already added this body to another space. You cannot add it to a second."),fd(b),b.bodies.push(a),a.space=b,a},ed.prototype.addConstraint=function(a){var b=this;j(a.space!=b,"You have already added this constraint to this space. You must not add it a second time."),j(!a.space,"You have already added this constraint to another space. You cannot add it to a second."),j(a.a&&a.b,"Constraint is attached to a null body."),fd(b),a.a.activate(),a.b.activate(),b.constraints.push(a);var c=a.a,d=a.b;return a.next_a=c.constraintList,c.constraintList=a,a.next_b=d.constraintList,d.constraintList=a,a.space=b,a},ed.prototype.filterArbiters=function(a,b){var c=this;c.lock();var d=c.cachedArbiters;for(var e in d){var f=d[e];(a==f.body_a&&(b==f.a||null==b)||a==f.body_b&&(b==f.b||null==b))&&(b&&f.state!=Cb&&f.callSeparate(c),f.unthread(),Fb(c.arbiters,f),delete d[e])}c.unlock(!0)},ed.prototype.removeShape=function(a){var b=this,c=a.body;c.isStatic()?b.removeStaticShape(a):(j(b.containsShape(a),"Cannot remove a shape that was not added to the space. (Removed twice maybe?)"),fd(b),c.activate(),c.removeShape(a),b.filterArbiters(c,a),b.activeShapes.remove(a,a.hashid),a.space=null)},ed.prototype.removeStaticShape=function(a){var b=this;j(b.containsShape(a),"Cannot remove a static or sleeping shape that was not added to the space. (Removed twice maybe?)"),fd(b);var c=a.body;c.isStatic()&&c.activateStatic(a),c.removeShape(a),b.filterArbiters(c,a),b.staticShapes.remove(a,a.hashid),a.space=null},ed.prototype.removeBody=function(a){var b=this;j(b.containsBody(a),"Cannot remove a body that was not added to the space. (Removed twice maybe?)"),fd(b),a.activate(),Fb(b.bodies,a),a.space=null},ed.prototype.removeConstraint=function(a){var b=this;j(b.containsConstraint(a),"Cannot remove a constraint that was not added to the space. (Removed twice maybe?)"),fd(b),a.a.activate(),a.b.activate(),Fb(b.constraints,a),a.a.removeConstraint(a),a.b.removeConstraint(a),a.space=null},ed.prototype.containsShape=function(a){return a.space==this},ed.prototype.containsBody=function(a){return a.space==this},ed.prototype.containsConstraint=function(a){return a.space==this},ed.prototype.convertBodyToStatic=function(a){var b=this;j(!a.isStatic(),"Body is already static."),j(a.isRogue(),"Remove the body from the space before calling this function."),fd(b),a.setMass(1/0),a.setMoment(1/0),a.setVel(P),a.setAngVel(0),a.nodeIdleTime=1/0;for(var c=a.shapeList;c;c=c.next)b.activeShapes.remove(c,c.hashid),b.staticShapes.insert(c,c.hashid)},ed.prototype.convertBodyToDynamic=function(a,b,c){var d=this;j(a.isStatic(),"Body is already dynamic."),fd(d),a.activateStatic(null),a.setMass(b),a.setMoment(c),a.nodeIdleTime=0;for(var e=a.shapeList;e;e=e.next)d.staticShapes.remove(e,e.hashid),d.activeShapes.insert(e,e.hashid)},ed.prototype.eachBody=function(a,b){var c=this;c.lock();for(var d=c.bodies,e=0;e<d.length;e++)a(d[e],b);for(var f=c.sleepingComponents,e=0;e<f.length;e++)for(var g=f[e],h=g;h;){var i=h.nodeNext;a(h,b),h=i}c.unlock(!0)},ed.prototype.eachShape=function(a,b){var c=this;c.lock(),c.activeShapes.each(a,b),c.staticShapes.each(a,b),c.unlock(!0)},ed.prototype.eachConstraint=function(a,b){var c=this;c.lock();for(var d=c.constraints,e=0;e<d.length;e++)a(d[e],b);c.unlock(!0)};var gd=function(a){var b=a.body;a.update(b.p,b.rot)};ed.prototype.reindexStatic=function(){var a=this;j(!a.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete."),a.staticShapes.each(gd,null),a.staticShapes.reindex()},ed.prototype.reindexShape=function(a){var b=this;j(!b.locked,"You cannot manually reindex objects while the space is locked. Wait until the current query or step is complete.");var c=a.body;a.update(c.p,c.rot),b.activeShapes.reindexObject(a,a.hashid),b.staticShapes.reindexObject(a,a.hashid)},ed.prototype.reindexShapesForBody=function(a){for(var b=this,c=a.shapeList;c;c=c.next)b.reindexShape(c)};var hd=function(a,b){b.insert(a,a.hashid)};ed.prototype.useSpatialHash=function(a,b){var c=this,d=new cpSpaceHash(a,b,cd,null),e=new cpSpaceHash(a,b,cd,d);c.staticShapes.each(hd,d),c.activeShapes.each(hd,e),c.staticShapes=d,c.activeShapes=e},ed.prototype.activateBody=function(a){var b=this;if(j(!a.isRogue(),"Internal error: Attempting to activate a rogue body."),b.locked)-1==b.rousedBodies.indexOf(a)&&b.rousedBodies.push(a);else{b.bodies.push(a);for(var c=a.shapeList;c;c=c.next)b.staticShapes.remove(c,c.hashid),b.activeShapes.insert(c,c.hashid);for(var d=a.arbiterList;d;d=d.next(a)){var e=d.body_a;if(a==e||e.isStatic()){var f=d.a,g=d.b,h=l(f.hashid,g.hashid);b.cachedArbiters[h]=d,d.stamp=b.stamp,d.handler=b.lookupHandler(f.collision_type,g.collision_type),b.arbiters.push(d)}}for(var i=a.constraintList;i;i=i.next(a)){var e=i.a;(a==e||e.isStatic())&&b.constraints.push(i)}}},ed.prototype.deactivateBody=function(a){var b=this;j(!a.isRogue(),"Internal error: Attempting to deactivate a rouge body."),Fb(b.bodies,a);for(var c=a.shapeList;c;c=c.next)b.activeShapes.remove(c,c.hashid),b.staticShapes.insert(c,c.hashid);for(var d=a.arbiterList;d;d=d.next(a)){var e=d.body_a;(a==e||e.isStatic())&&b.uncacheArbiter(d)}for(var f=a.constraintList;f;f=f.next(a)){var e=f.a;(a==e||e.isStatic())&&Fb(b.constraints,f)}};var id=function(a){return a?a.nodeRoot:null},jd=function(a){if(a&&a.isSleeping()){j(!a.isRogue(),"Internal Error: ComponentActivate() called on a rogue body.");for(var b=a.space,c=a;c;){var d=c.nodeNext;c.nodeIdleTime=0,c.nodeRoot=null,c.nodeNext=null,b.activateBody(c),c=d}Fb(b.sleepingComponents,a)}};Xb.prototype.activate=function(){var a=this;a.isRogue()||(a.nodeIdleTime=0,jd(id(a)));for(var b=a.arbiterList;b;b=b.next(a)){var c=b.body_a==a?b.body_b:b.body_a;c.isStatic()||(c.nodeIdleTime=0)}},Xb.prototype.activateStatic=function(a){var b=this;j(b.isStatic(),"cpBodyActivateStatic() called on a non-static body.");for(var c=b.arbiterList;c;c=c.next(b))a&&a!=c.a&&a!=c.b||(c.body_a==b?c.body_b:c.body_a).activate()},Xb.prototype.pushArbiter=function(a){var b=this,c=b.arbiterList;a.threadForBody(b).next=c,c&&(c.threadForBody(b).prev=a),b.arbiterList=a};var kd=function(a,b){b.nodeRoot=a,b!=a&&(b.nodeNext=a.nodeNext,a.nodeNext=b)},ld=function(a,b){if(!b.isRogue()){var c=id(b);if(null==c){kd(a,b);for(var d=b.arbiterList;d;d=d.next(b))ld(a,b==d.body_a?d.body_b:d.body_a);for(var e=b.constraintList;e;e=e.next(b))ld(a,b==e.a?e.b:e.a)}}},md=function(a,b){for(var c=a;c;c=c.nodeNext)if(c.nodeIdleTime<b)return!0;return!1};ed.prototype.processComponents=function(a){var b,c,d=this,e=1/0!=d.sleepTimeThreshold,f=d.bodies;if(e)for(var g=d.idleSpeedThreshold,h=g?g*g:_(d.gravity)*a*a,b=0;b<f.length;b++){var c=f[b],i=h?c.m*h:0;c.nodeIdleTime=c.kineticEnergy()>i?0:c.nodeIdleTime+a}for(var j=d.arbiters,b=0,k=j.length;k>b;b++){var l=j[b],m=l.body_a,n=l.body_b;e&&((n.isRogue()&&!n.isStatic()||m.isSleeping())&&m.activate(),(m.isRogue()&&!m.isStatic()||n.isSleeping())&&n.activate()),m.pushArbiter(l),n.pushArbiter(l)}if(e){for(var o=d.constraints,b=0;b<o.length;b++){var p=o[b],m=p.a,n=p.b;n.isRogue()&&!n.isStatic()&&m.activate(),m.isRogue()&&!m.isStatic()&&n.activate()}for(var b=0;b<f.length;){var c=f[b];if(null!=id(c)||(ld(c,c),md(c,d.sleepTimeThreshold)))b++,c.nodeRoot=null,c.nodeNext=null;else{d.sleepingComponents.push(c);for(var q=c;q;q=q.nodeNext)d.deactivateBody(q)}}}},Xb.prototype.sleep=function(){var a=this;a.sleepWithGroup(null)},Xb.prototype.sleepWithGroup=function(a){var b=this;j(!b.isRogue(),"Rogue (and static) bodies cannot be put to sleep.");var c=b.space;if(j(!c.locked,"Bodies cannot be put to sleep during a query or a call to cpSpaceStep(). Put these calls into a post-step callback."),j(null==a||a.isSleeping(),"Cannot use a non-sleeping body as a group identifier."),b.isSleeping())return j(id(b)==id(a),"The body is already sleeping and it's group cannot be reassigned."),void 0;for(var d=b.shapeList;d;d=d.next)d.update(b.p,b.rot);if(c.deactivateBody(b),a){var e=id(a);b.nodeRoot=e,b.nodeNext=e.nodeNext,b.nodeIdleTime=0,e.nodeNext=b}else b.nodeRoot=b,b.nodeNext=null,b.nodeIdleTime=0,c.sleepingComponents.push(b);Fb(c.bodies,b)};var nd=function(a){a.body.activate()};ed.prototype.activateShapesTouchingShape=function(a){var b=this;1/0!=b.sleepTimeThreshold&&b.shapeQuery(a,nd,a)};var od=function(a,b,c,d,e){this.point=a,this.layers=b,this.group=c,this.func=d,this.data=e},pd=function(a,b,c){return(!b.group||a.group!=b.group)&&a.layers&b.layers&&b.pointQuery(a.point)&&a.func(b,a.data),c};ed.prototype.pointQuery=function(a,b,c,d,e){var f=this,g=new od(a,b,c,d,e),h=Hb(a,0);f.lock(),f.activeShapes.query(g,h,pd,e),f.staticShapes.query(g,h,pd,e),f.unlock(!0)},ed.prototype.pointQueryFirst=function(a,b,c){var d=this,e=null;return d.pointQuery(a,b,c,function(a){a.sensor||(e=a)}),e};var qd=function(a,b,c,d,e){this.point=a,this.maxDistance=b,this.layers=c,this.group=d,this.func=e},rd=function(a,b,c,d){if((!b.group||a.group!=b.group)&&a.layers&b.layers){var e=b.nearestPointQuery(a.point);e&&e.shape&&e.d<a.maxDistance&&a.func(b,e.d,e.p,d)}return c};ed.prototype.nearestPointQuery=function(a,b,c,d,e,f){var g=this,h=new qd(a,b,c,d,e),i=Gb.newForCircle(a,F(b,0));g.lock(),g.activeShapes.query(h,i,rd,f),g.staticShapes.query(h,i,rd,f),g.unlock(!0)};var sd=function(a,b,c,d){if((!b.group||a.group!=b.group)&&a.layers&b.layers&&!b.sensor){var e=b.nearestPointQuery(a.point);e&&e.d<d.d&&h(d,e)}return c};ed.prototype.nearestPointQueryNearest=function(a,b,c,d){var e=this,f=new Pc(null,P,b,P),g=new qd(a,b,c,d,null),h=Gb.newForCircle(a,F(b,0));return e.activeShapes.query(g,h,sd,f),e.staticShapes.query(g,h,sd,f),f.shape?f:null};var td=function(a,b,c,d,e){this.start=a,this.end=b,this.layers=c,this.group=d,this.func=e},ud=function(a,b,c){var d;return(!b.group||a.group!=b.group)&&a.layers&b.layers&&(d=b.segmentQuery(a.start,a.end))&&a.func(b,d.t,d.n,c),1};ed.prototype.segmentQuery=function(a,b,c,d,e,f){var g=this,h=new td(a,b,c,d,e);g.lock(),g.staticShapes.segmentQuery(h,a,b,1,ud,f),g.activeShapes.segmentQuery(h,a,b,1,ud,f),g.unlock(!0)};var vd=function(a,b,c){var d;return(!b.group||a.group!=b.group)&&a.layers&b.layers&&!b.sensor&&(d=b.segmentQuery(a.start,a.end))&&d.t<c.t&&h(c,d),c.t};ed.prototype.segmentQueryFirst=function(a,b,c,d){var e=this,f=new Qc(null,1,P),g=new td(a,b,c,d,null);return e.staticShapes.segmentQuery(g,a,b,1,vd,f),e.activeShapes.segmentQuery(g,a,b,f.t,vd,f),f.shape?f:null};var wd=function(a,b,c,d){this.bb=a,this.layers=b,this.group=c,this.func=d},xd=function(a,b,c,d){return(!b.group||a.group!=b.group)&&a.layers&b.layers&&a.bb.intersects(b.bb)&&a.func(b,d),c};ed.prototype.bBQuery=function(a,b,c,d,e){var f=this,g=new wd(a,b,c,d);f.lock(),f.activeShapes.query(g,a,xd,e),f.staticShapes.query(g,a,xd,e),f.unlock(!0)};var yd=function(a,b,c){this.func=a,this.data=b,this.anyCollision=c},zd=function(a,b,c,d){if(a.group&&a.group==b.group||!(a.layers&b.layers)||a==b)return c;var e=[],f=0;if(a.type<=b.type)Kc(a,b,c,e),f=e.length;else{Kc(b,a,c,e),f=e.length;for(var g=0;f>g;g++)e[g].n=T(e[g].n)}if(f&&(d.anyCollision=!(a.sensor||b.sensor),d.func)){var h=new Eb;h.count=f;for(var i,g=0;f>g;g++)i=e[g],h.points[g]=new Db(i.p,i.n,i.dist);d.func(b,h,d.data)}return c};ed.prototype.shapeQuery=function(a,b,c){var d=this,e=a.body,f=e?a.update(e.p,e.rot):a.bb,g=new yd(b,c,!1);return d.lock(),d.activeShapes.query(a,f,zd,g),d.staticShapes.query(a,f,zd,g),d.unlock(!0),g.anyCollision},ed.prototype.getPostStepCallback=function(a){for(var b=this,c=b.postStepCallbacks,d=0;d<c.length;d++){var e=c[d];if(e&&e.key==a)return e}return null},ed.prototype.addPostStepCallback=function(a,b,c){var d=this;if(d.getPostStepCallback(b))return!1;var e=new Id(a?a:g(),b,c);return d.postStepCallbacks.push(e),!0},ed.prototype.lock=function(){var a=this;a.locked++},ed.prototype.unlock=function(a){var b=this;if(b.locked--,j(b.locked>=0,"Internal Error: Space lock underflow."),0==b.locked){for(var c,d=b.rousedBodies;c=d.pop();)b.activateBody(c);if(0==b.locked&&a&&!b.skipPostStep){b.skipPostStep=!0;for(var e,f=b.postStepCallbacks;e=f.pop();){var g=e.func;e.func=null,g&&g(b,e.key,e.data)}b.skipPostStep=!1}}};var Ad=function(a,b){var c=!a.bb.intersects(b.bb)||a.body==b.body||a.group&&a.group==b.group||!(a.layers&b.layers)||1/0==a.body.m&&1/0==b.body.m;return c},Bd=function(a,b,c,d){if(Ad(a,b))return c;var e=d.lookupHandler(a.collision_type,b.collision_type),f=a.sensor||b.sensor;if(f&&e==dd)return c;if(a.type>b.type||a.type==b.type&&b>a){var g=a;a=b,b=g}var h=[],i={id:c};Kc(a,b,i,h);var j=h.length;if(!j)return i.id;var k=l(a.hashid,b.hashid),m=d.cachedArbiters[k];return m||(m=d.pooledArbiters.pop(),m?m.reset(a,b):m=d.cachedArbiters[k]=new xb(a,b)),m.update(h,e,a,b),m.state!=zb||e.begin(m,d,e.data)||m.ignore(),m.state!=Bb&&e.preSolve(m,d,e.data)&&!f?d.arbiters.push(m):(m.contacts=null,m.state!=Bb&&(m.state=Ab)),m.stamp=d.stamp,i.id};ed.prototype.arbiterSetFilter=function(a){var b=this,c=b.stamp-a.stamp,d=a.body_a,e=a.body_b;return(d.isStatic()||d.isSleeping())&&(e.isStatic()||e.isSleeping())?!0:(c>=1&&a.state!=Cb&&(a.state=Cb,a.callSeparate(b)),c>=b.collisionPersistence?(a.contacts=null,b.pooledArbiters.push(a),!1):!0)};var Cd=function(a){var b=a.body;a.update(b.p,b.rot)};ed.prototype.step=function(a){var b=this;if(0!=a){b.stamp++;var c=b.curr_dt;b.curr_dt=a;for(var d,e=b.bodies,f=b.constraints,g=b.arbiters;d=g.pop();)d.state=Ab,d.body_a.isSleeping()||d.body_b.isSleeping()||d.unthread();b.lock();for(var h=0;h<e.length;h++){var i=e[h];i.updatePosition(a)}b.activeShapes.each(Cd,null),b.activeShapes.reindexQuery(Bd,b),b.unlock(!1),b.processComponents(a),b.lock();var j=b.cachedArbiters;for(var k in j)this.arbiterSetFilter(j[k])||delete j[k];for(var l=g.length,m=f.length,n=b.collisionSlop,o=1-A(b.collisionBias,a),h=0;l>h;h++)g[h].preStep(a,n,o);for(var h=0;m>h;h++){var p=f[h];p.preSolve(b),p.preStep(a)}for(var q=A(b.damping,a),r=b.gravity,h=0;h<e.length;h++){var i=e[h];i.updateVelocity(r,q,a)}for(var s=0==c?0:a/c,h=0;l>h;h++)g[h].applyCachedImpulse(s);for(var h=0;m>h;h++){var p=f[h];p.applyCachedImpulse(s)}for(var h=0;h<b.iterations;h++){for(var t=0;l>t;t++)g[t].applyImpulse();for(var t=0;m>t;t++){var p=f[t];p.applyImpulse(a)}}for(var h=0;m>h;h++){var p=f[h];p.postSolve(b)}for(var h=0;l>h;h++){var d=g[h],u=d.handler;u.postSolve(d,b,u.data)}b.unlock(!0)}},Xb.prototype.isSleeping=function(){return null!=this.nodeRoot},Xb.prototype.isStatic=function(){return 1/0==this.nodeIdleTime},Xb.prototype.isRogue=function(){return null==this.space},Xb.prototype.local2World=function(a){var b=this;return R(b.p,Z(a,b.rot))},Xb.prototype.world2Local=function(a){var b=this;return $(S(a,b.p),b.rot)},Xb.prototype.kineticEnergy=function(){var a=this,b=V(a.v,a.v),c=a.w*a.w;return(b?b*a.m:0)+(c?c*a.i:0)},ed.prototype.isLocked=function(){return this.locked};var Dd=1e-5;hb.prototype.next=function(a){var b=this;return b.a==a?b.next_a:b.next_b},xb.prototype.next=function(a){var b=this;return b.body_a==a?b.thread_a.next:b.thread_b.next};var Ed=function(a,b,c){var d=b.x-c.x,e=b.y-c.y,f=J((d*(a.x-c.x)+e*(a.y-c.y))/(d*d+e*e));return new N(c.x+d*f,c.y+e*f)};Sc.prototype.active=function(){var a=this;return a.prev||a.body&&a.body.shapeList==a};var Fd=function(a,b,c,d,e){var f=S(d,b),g=S(e,b),h=V(f,f)-2*V(f,g)+V(g,g),i=-2*V(f,f)+2*V(f,g),j=V(f,f)-c*c,k=i*i-4*h*j;if(k>=0){var l=(-i-t(k))/(2*h);if(l>=0&&1>=l)return new Qc(a,l,cb(bb(f,g,l)))}},Gd=function(a,b){this.n=a,this.d=b},Hd=function(a,b){var c=cb(X(S(b,a))),d=V(c,a);return new Gd(c,d)};Gd.prototype.compare=function(a){var b=this;return V(b.n,a)-b.d};var Id=function(a,b,c){this.func=a,this.key=b,this.data=c};ed.prototype.lookupHandler=function(a,b){return this.collisionHandlers[l(a,b)]||this.defaultHandler},ed.prototype.uncacheArbiter=function(a){var b=this,c=a.a,d=a.b,e=l(c.hashid,d.hashid);delete b.cachedArbiters[e],Fb(b.arbiters,a)},xb.prototype.callSeparate=function(a){var b=this,c=a.lookupHandler(b.a.collision_type,b.b.collision_type);c.separate(b,a,c.data)},xb.prototype.threadForBody=function(a){var b=this;return b.body_a==a?b.thread_a:b.thread_b},hb.prototype.activateBodies=function(){var a=this,b=a.a;b&&b.activate();var c=a.b;c&&c.activate()};var Jd=function(a,b,c,d){var e=b.v.x-d.y*b.w-(a.v.x-c.y*a.w),f=b.v.y+d.x*b.w-(a.v.y+c.x*a.w);return new N(e,f)},Kd=function(a,b,c,d,e){var f=b.v.x-d.y*b.w-(a.v.x-c.y*a.w),g=b.v.y+d.x*b.w-(a.v.y+c.x*a.w);return f*e.x+g*e.y},Ld=function(a,b,c){a.v.x+=b.x*a.m_inv,a.v.y+=b.y*a.m_inv,a.w+=a.i_inv*(c.x*b.y-c.y*b.x)},Md=function(a,b,c,d,e){var f=e.x,g=e.y;a.v.x+=-f*a.m_inv,a.v.y+=-g*a.m_inv,a.w+=a.i_inv*(-c.x*g+c.y*f),b.v.x+=f*b.m_inv,b.v.y+=g*b.m_inv,b.w+=b.i_inv*(d.x*g-d.y*f)},Nd=function(a,b,c){var d=W(b,c);return a.m_inv+a.i_inv*d*d},Od=function(a,b,c,d,e){var f=Nd(a,c,e)+Nd(b,d,e);return f},Pd=function(a,b,c,d){var e=a.m_inv+b.m_inv,f=e,g=0,h=0,i=e,j=a.i_inv,k=c.x*c.x*j,l=c.y*c.y*j,m=-c.x*c.y*j;f+=l,g+=m,h+=m,i+=k;var n=b.i_inv,o=d.x*d.x*n,p=d.y*d.y*n,q=-d.x*d.y*n;f+=p,g+=q,h+=q,i+=o;var r=f*i-g*h,s=1/r;return new M(i*s,-g*s,-h*s,f*s)},Qd=f.biasCoef=function(a,b){return 1-A(a,b)}}({},function(){return this}());